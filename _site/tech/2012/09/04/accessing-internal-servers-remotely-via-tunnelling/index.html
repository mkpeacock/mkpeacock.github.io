
<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <!-- Title -->
    <title>Accessing Internal Servers Remotely Via Tunnelling</title>
    
    <meta name="author" content="Name Lastname">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Description, Keywords -->
    <meta name="description" content="">
    <meta name="keywords" content="">
    <meta name="author" content="">
    <!-- Google web fonts -->
    <link href='http://fonts.googleapis.com/css?family=Oswald:400,700' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=PT+Sans:400,700,400italic' rel='stylesheet' type='text/css'>

    <!-- Stylesheets -->
    <link href="/assets/style/bootstrap.css" rel="stylesheet">
    <link href="/assets/style/flexslider.css" rel="stylesheet">
    <link href="/assets/style/prettyPhoto.css" rel="stylesheet">
    <link rel="stylesheet" href="/assets/style/font-awesome.css">
    <!--[if IE 7]>
    <link rel="stylesheet" href="/style/font-awesome-ie7.css">
    <![endif]-->
    <link href="/assets/style/style.css" rel="stylesheet">
    <!-- Color Stylesheet - orange, blue, pink, brown, red or green-->
    <link href="/assets/style/blue.css" rel="stylesheet">
    <link href="/assets/style/bootstrap-responsive.css" rel="stylesheet">

    <!-- HTML5 Support for IE -->
    <!--[if lt IE 9]>
    <script src="/js/html5shim.js"></script>
    <![endif]-->
    <!-- Favicon -->
    <link rel="shortcut icon" href="/assets/img/favicon/favicon.png">
</head>
<body>
<!-- Header starts -->
    <header>
        <div class="container">
            <div class="row">
                <div class="span6">
                    <!-- Logo and site link -->
                    <div class="logo">
                        <h1><a href="index.html">Michael Peacock<span class="color">.</span></a></h1>
                    </div>
                </div>
                <div class="span4 offset2">
                    <div class="list">
                       <!-- Add your phone number here -->
                       <div class="phone">
                          <i class="icon-twitter"></i> @michaelpeacock
                       </div>
                       <hr />
                       <!-- Add your email id here -->
                       <div class="email">
                          <i class="icon-envelope-alt"></i> mkpeacock@gmail.com
                       </div>
                       <hr />
                       <!-- Add your address here -->
                       <div class="address">
                          <i class="icon-linkedin"></i> <i class="icon-facebook"></i> <i class="icon-twitter"></i> <i class="icon-github"></i> Elsewhere
                       </div>
                    </div>
                </div>
            </div>
        </div>
    </header>


<!-- Header ends -->

<!-- Navigation Starts -->

    <div class="navbar">
        <div class="navbar-inner">
            <div class="container">
                <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">Menu</a>
                <div class="nav-collapse collapse">
                <!-- Navigation links starts here -->
                    <ul class="nav">
                        <!-- Main menu -->
                        <li><a href="/index.html">Home</a></li>
                        <li><a href="/about.html">About</a></li>
                        <li><a href="/blog.html">Blog</a></li>
                        <li><a href="/publications.html">Publications</a></li>
                        <li><a href="/talks.html">Talks</a></li>
                        <li><a href="/portfolio.html">Portfolio</a></li>
                        <li><a href="/open-source.html">Open source</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <!-- Navigation Ends -->

<!-- Content strats -->

    <div class="content">
      
<div class="page-header">
  <h1>Accessing Internal Servers Remotely Via Tunnelling <small>Supporting tagline</small></h1>
</div>

<div class="row-fluid post-full">
  <div class="span12">
    <div class="date">
      <span>04 September 2012</span>
    </div>
    <div class="content">
      <p>Over at <a href='http://www.groundsix.com'>Ground Six</a> the development team each run a number of virtual machines hosting their development environment. We also have an internal ESXi server which hosts a number of projects and staging areas.</p>

<p>For our local machines, tools such as <a href='http://progrium.com/localtunnel/'>LocalTunnel</a> and <a href='https://pagekite.net/'>PageKite</a> are great. These are free services which tunnel out and expose a particular port (for us this is always the web server) on a subdomain they provide. This is essential for testing services with webhooks such as PayPal or GoCardless.</p>

<p>Both of these services are very good and customisable. The v2 of LocalTunnel and PageKite offer some facility to run your own service or front-end without needing to rely on their own servers. Unfortunately, LocalTunnel v2 is very much unstable software, and PageKites documentation is a little overwhelming (although I&#8217;m told their rpm and deb files help with that). With this in mind I set about putting something (very basic) together myself, primarily for the servers we have running on our ESXi box; PageKite is more than suitable for our local machines for now.</p>

<h2 id='how_it_works'>How it works</h2>

<p>One thing I didn&#8217;t realise with SSH, was that when you connect from one machine to another, you can specify a port binding, that allows you to bind a port on one machine to another. This binding can work in one of two ways:</p>

<ul>
<li>Local: You can connect to a remote machine and bind a port from that machine to a local port</li>

<li>Remote: You can connect to a remote machine and bind a port from the local machine onto the remote machine</li>
</ul>

<p>It is the latter of these two options that allows us to use this approach, as these machines are behind a NAT enabled network, and we have no access to the router which connects to the ISP - so we can&#8217;t setup dynamic DNS style services.</p>

<h2 id='external_server'>External Server</h2>

<p>In order for us to tunnel into our local network, there needs to be an external server which acts as a gateway. A cheap and cheerful VPS will suffice for this. Let&#8217;s look at what we will need to do:</p>

<h3 id='enable_port_forwarding_via_ssh'>Enable port forwarding via SSH</h3>

<p>Use mod_proxy to redirect specific subdomains to specific ports (we don&#8217;t really want to be using a range of port numbers to access HTTP traffic, we want to use nice subdomains)</p>

<p>Point a wildcard subdomain to the server (For me, the subdomain is actually the server name so its a wildcard subdomain <code>*.servername.platformname.com</code>).</p>

<h3 id='ssh_settings'>SSH Settings</h3>

<p>I&#8217;m using OpenSSH on Ubuntu for the Gateway server, there were some changes / additions needed in the config file (/etc/ssh/sshd_conf). Ensure the following setting value pairs are present:</p>

<pre><code>AllowTcpForwarding  yes
X11Forwarding yes
GatewayPorts   yes
AddressFamily inet</code></pre>

<p>Reload sshd:</p>

<pre><code>sudo /etc/init.d/sshd reload</code></pre>

<p>I&#8217;ve also setup my SSH server to work with keys, and setup keys for the team - so when we expose an Internal VM to the outside world, we can script it without the need for passwords.</p>

<h3 id='mod_proxy'>mod_proxy</h3>

<p>The apache module mod_proxy lets us, among other things, map a request to a specific virtual host to a different port. This means for each VM connected to our gateway, each with a different port mapping - we can give them their own virtual host, without having to worry about which port is used by which machine.</p>

<h4 id='install'>Install</h4>

<pre><code>sudo apt-get install libapache2-mod-proxy-html
sudo apt-get install libxml2-dev</code></pre>

<h4 id='enable'>Enable</h4>

<pre><code>sudo nano /etc/apache2/apache2.conf</code></pre>

<p>Add at the end: LoadModule proxy_module /usr/lib/apache2/modules/mod_proxy.so LoadModule proxy_http_module /usr/lib/apache2/modules/mod_proxy_http.so LoadModule headers_module /usr/lib/apache2/modules/mod_headers.so LoadModule deflate_module /usr/lib/apache2/modules/mod_deflate.so</p>

<p>Reload apache to apply:</p>

<pre><code>sudo /etc/init.d/apache2 restart</code></pre>

<h4 id='configure_virtual_host'>Configure virtual host</h4>

<p>Edit your existing virtual host or create a new one. ServerAdmin email@domain.com ServerName sub.domain.platform.com ProxyPass / http://sub.domain.platform.com:10000/ ProxyPassReverse / http://sub.domain.platform.com:10000/ DirectoryIndex index.php DocumentRoot /var/www&lt;</p>

<p>If creating a new virtualhost, enable it: sudo a2ensite virtualhostname</p>

<p>Reload apache:</p>

<pre><code>sudo /etc/init.d/apache2 reload</code></pre>

<h2 id='wildcard_dns'>Wildcard DNS</h2>

<p>If you want multiple machines routed through, then you will probably want a wildcard subdomain setup at your DNS level.</p>

<h2 id='ssh_with_remote_port_binding'>SSH with Remote Port Binding</h2>

<p>The key to the whole operation.</p>

<p>From our internal, NAT enabled machine, we simply run the following command:</p>

<pre><code>ssh user@gatewaymachine -R 10000:localhost:80</code></pre>

<p>This will connect to our gateway machine, and set port 10000 on the gateway to map to port 80 on our specific internal VM.</p>

<h3 id='autossh'>AutoSSH</h3>

<p>Depending on your Internet connection, SSH may not be very reliable. There are some setting changes you can make to ensure the connection is maintained even when idle (), however this does not help when the connection is severed. AutoSSH helps you maintain a continuous connection, reconnecting when it does disconnect.</p>

<pre><code>sudo apt-get install autossh</code></pre>

<p>Then use the ssh command as above, but with autossh in place of ssh. You can now access your internal services from the outside world!</p>
    </div>

  
    <ul class="tag_box inline">
      <li><i class="icon-folder-open"></i></li>
      
      


  
     
    	<li><a href="/categories.html#tech-ref">
    		tech <span>1</span>
    	</a></li>
    
  


    </ul>
    

  
    <ul class="tag_box inline">
      <li><i class="icon-tags"></i></li>
      
      


  
     
    	<li><a href="/tags.html#intro-ref">intro <span>2</span></a></li>
     
    	<li><a href="/tags.html#beginner-ref">beginner <span>2</span></a></li>
     
    	<li><a href="/tags.html#jekyll-ref">jekyll <span>2</span></a></li>
     
    	<li><a href="/tags.html#tutorial-ref">tutorial <span>2</span></a></li>
    
  



    </ul>
    

    <hr>
    <div class="pagination">
      <ul>
      
        <li class="prev"><a href="/lessons/2011/12/29/jekyll-introduction" title="Jekyll Introduction">&larr; Previous</a></li>
      
        <li><a href="/archive.html">Archive</a></li>
      
        <li class="next disabled"><a>Next &rarr;</a>
      
      </ul>
    </div>
    <hr>
    


  <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_developer = 1;
    var disqus_shortname = 'jekyllbootstrap'; // required: replace example with your forum shortname
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>




  </div>
</div>


    </div>

<!-- Footer -->
<footer>
  <div class="container">
    <div class="row">
      <div class="span4">
         <!-- Widget 1 -->
         <div class="widget">
            <h4>About Us</h4>
            <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Cras elementum dolor eget nisi fermentum quis hendrerit magna vestibulum. </p>
             <ul>
               <li><a href="#">Sed eu leo orci, condimentum gravida metus</a></li>
               <li><a href="#">Etiam at nulla ipsum, in rhoncus purus</a></li>
             </ul>
         </div>
      </div>
      <div class="span4">
         <!-- Widget 2 -->
         <div class="widget">
            <h4>Recent Posts</h4>
               <ul>
                  <li><a href="#">Recent post</a></li>
               </ul>
         </div>
      </div>
      <div class="span4">
         <!-- Widget 3 -->
         <div class="widget">
            <h4>Categories</h4>
            <ul>
               <li><a href="#">Category</a></li>
            </ul>
         </div>
      </div>

      <div class="span12"><hr /><p class="copy">
               Copyright &copy; <a href="http://www.michaelpeacock.co.uk">Michael Peacock</a></p></div>
    </div>
  </div>
</footer>

<!-- JS -->
<script src="/assets/js/jquery.js"></script>
<script src="/assets/js/bootstrap.js"></script>
<script src="/assets/js/jquery.flexslider-min.js"></script>
<script src="/assets/js/jquery.isotope.js"></script>
<script src="/assets/js/jquery.prettyPhoto.js"></script>
<script src="/assets/js/filter.js"></script>
<script src="/assets/js/custom.js"></script>
</body>
</html>



